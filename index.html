<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Batch Background Removal & Item Attachment</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/beerslider/dist/BeerSlider.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css">

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <style>
    /* Existing Styles */
    .image-card {
      margin-bottom: 20px;
      transition: opacity 0.3s ease-in-out;
    }
    .image-card.trashed-card {
        opacity: 0.6;
    }
    .beerslider-wrapper-container {
      width: 100%;
      aspect-ratio: 1 / 1;
      border: 1px solid #ccc;
      position: relative;
    }
    .beerslider-wrapper-container.img-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: #f0f0f0;
      color: #aaa;
      font-size: 0.9em;
      text-align: center;
      height: 100%;
    }
    .beer-slider img {
      display: block;
      max-width: 100%;
      height: auto;
      object-fit: contain;
    }
    .status-badge, .marker-badge {
      font-size: 0.8em;
    }
    .card-footer {
      background-color: #f8f9fa;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .trash-btn {
        color: #dc3545;
        cursor: pointer;
    }
    .trash-btn:hover { color: #bd2130; }

    /* Styles for thumbnails in modal */
    .modal-thumbnail-item {
        position: relative;
        border: 1px solid #ddd;
        padding: 5px;
        background-color: #f9f9f9;
    }
    .modal-thumbnail-item img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        display: block;
    }
    .modal-thumbnail-item .remove-img-btn {
        position: absolute;
        top: -5px;
        right: -5px;
        background-color: rgba(255, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        line-height: 18px;
        text-align: center;
        cursor: pointer;
        padding: 0;
    }
    .modal-thumbnail-item .remove-img-btn:hover {
        background-color: rgba(200, 0, 0, 0.9);
    }


    /* New E-commerce Form Styles (from provided snippet) */
    .gtabs {
        position: relative;
        margin: auto;
        width: 100%;
    }
    .gtabs .gtab {
        background: #eee;
        position: absolute;
        opacity: 0;
        visibility: hidden;
        margin: auto;
        padding: 10px;
        top: 5px;
        transition: all 0.4s;
        width: 100%; /* Ensure gtab takes full width for centering content */
    }
    .gtabs .gtab.active {
        opacity: 1;
        visibility: visible;
        top: 0;
        transition: all 0.4s;
        position: relative; /* Change to relative when active to take space */
    }
    /* .btn.active { } */ /* This was commented out, likely not needed or handled by Bootstrap */

    .viewport { /* For QuaggaJS */
        position: relative;
        width: 100%;
        overflow: hidden;
    }
    .drawingBuffer { /* For QuaggaJS */
        position: absolute;
        top: 0;
        left: 0;
    }
    .table-container { /* Not directly used in modal, but kept if other parts of page use it */
        display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; padding: 15px;
    }
    .table-item { /* For "Draft Mode Status" checkbox in modal */
        /* flex: 1; min-width: 280px; max-width: 450px; */ /* Adjusted for modal context */
        border: 1px solid #ccc; padding: 10px; text-align: center; border-radius: 8px;
        background-color: #f9f9f9; display: flex; flex-direction: column;
        align-items: center; gap: 10px; margin-bottom: 15px;
    }
    .table-item p { font-size: 14px; font-style: italic; margin-bottom: 5px; color: #666; }

    .checkbox-container { display: flex; align-items: center; gap: 12px; }
    .checkbox-container label { font-weight: bold; display: flex; align-items: center; gap: 10px; font-size: 18px; white-space: nowrap; }
    .icon { font-size: 24px; color: #007bff; }
    .large-checkbox { width: 22px; height: 22px; transform: scale(1.5); cursor: pointer; }

    /* @@media (max-width: 600px) { .table-container { flex-direction: column; align-items: center; } } */ /* May not be relevant for modal */

    .form-box {
        background-color: #f9f9f9; border: 1px solid #ccc; border-radius: 8px;
        padding: 15px; margin-bottom: 15px; box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.05);
    }
    .form-box label { font-weight: bold; display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
    .form-box input, .form-box textarea, .form-box select {
        width: 100%; border: 1px solid #ccc; border-radius: 6px; padding: 10px; font-size: 16px;
    }
    .form-box input:focus, .form-box textarea:focus, .form-box select:focus {
        border-color: #007bff; outline: none; box-shadow: 0px 0px 8px rgba(0, 123, 255, 0.3);
    }
    .price-fields { display: flex; justify-content: space-between; gap: 15px; }
    .price-box { flex: 1; }

    .button-container { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
    .styled-button {
        background-color: #007bff; color: white; font-size: 18px; font-weight: bold;
        padding: 12px 25px; border: none; border-radius: 8px; transition: all 0.3s ease-in-out;
        box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
    }
    .styled-button-light { background-color: #f8f9fa; color: #333; }
    .styled-button:hover, .styled-button:focus { background-color: #0056b3; box-shadow: 2px 2px 12px rgba(0, 0, 0, 0.2); transform: scale(1.05); }
    .styled-button-light:hover, .styled-button-light:focus { background-color: #e2e6ea; transform: scale(1.05); }

    #scanCounterOuter { text-align: center; font-size: 16px; font-weight: bold; margin-top: 10px; }
    #barcode-container {
        text-align: center; max-width: 100%; /* Adjusted for modal */ margin: 20px auto; padding: 10px;
        border-radius: 10px; background: #f8f9fa; box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
    }
    #barcode-scanner { position: relative; width: 100%; max-width: 480px; /* Smaller for modal */ height: auto; aspect-ratio: 640 / 480; overflow: hidden; margin: 0 auto;}
    #barcode-scanner canvas.drawingBuffer, #barcode-scanner video { position: absolute; top: 0; left: 0; width: 100% !important; height: 100% !important; }
    #barcode-scanner video { object-fit: cover; }
    #barcode-result { font-size: 18px; margin-top: 10px; color: #28a745; font-weight: bold; }
    #btnScan { margin-top: 15px; padding: 10px 20px; font-size: 16px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
    #btnScan:hover { background-color: #0056b3; }
    #itemLoading img { width: 50px; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>Batch Background Removal</h1>
      <!-- BG Removal Service Status Badge (Example) -->
      <span id="bgStatusBadge" class="badge bg-info">Checking BG Service...</span>
    </div>

    <form id="uploadForm" class="mb-4">
      <!-- ... (upload form from original page) ... -->
      <div class="mb-3">
        <label for="imageFiles" class="form-label">Select Images (PNG, JPG, WebP):</label>
        <input type="file" class="form-control" id="imageFiles" multiple accept="image/png, image/jpeg, image/webp"/>
      </div>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="modelSelect" class="form-label">Model:</label>
          <select id="modelSelect" class="form-select">
            <option value="u2net" selected>U2Net (General Purpose)</option>
            <option value="u2netp">U2Netp (Lightweight)</option>
            <option value="u2net_human_seg">U2Net Human Segmentation</option>
            <option value="u2net_cloth_seg">U2Net Cloth Segmentation</option>
            <option value="silueta">Silueta (Alternative to U2Net)</option>
            <option value="isnet-general-use">IS-Net General Use</option>
            <option value="isnet-anime">IS-Net Anime</option>
          </select>
        </div>
        <div class="col-md-4 mb-3 d-flex align-items-end">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="postProcessCheck"/>
            <label class="form-check-label" for="postProcessCheck">Enable Post-Processing (Alpha Matting)</label>
          </div>
        </div>
        <div class="col-md-4 mb-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100" id="bgremove">Process Selected Images</button>
        </div>
      </div>
    </form>

    <hr />

    <div id="attachButtonContainer" class="mb-3 text-end" style="display: none;">
        <button id="attachImagesButton" class="btn btn-info btn-lg" disabled>
            Attach Selected to Item
        </button>
    </div>

    <div id="results" class="row mt-4">
      <!-- Image cards will be appended here -->
    </div>
  </div>

  <!-- Item Attachment Modal -->
  <div class="modal fade" id="itemAttachmentModal" tabindex="-1" aria-labelledby="itemAttachmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl"> <!-- modal-xl for more space -->
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="itemAttachmentModalLabel">Attach Images and Enter Item Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <h6>Selected Images for Attachment:</h6>
            <div id="selectedImagesThumbnailsContainer" class="mb-3 d-flex flex-wrap gap-2">
                <!-- Thumbnails with remove buttons will be injected here -->
            </div>
            <hr>

            <!-- E-commerce Form (from provided snippet) -->
            <div class="button-container">
                <button data-toggle="tab" data-tabs=".gtabs.modal-demo" data-tab=".modaltab-1" id="modalScanBtn"
                        class="styled-button modal-tab-trigger">
                    <i class="bi bi-upc-scan"></i> SCAN BARCODE
                </button>
                <button data-toggle="tab" data-tabs=".gtabs.modal-demo" data-tab=".modaltab-2" id="modalTypeBtn"
                        class="styled-button styled-button-light modal-tab-trigger">
                    <i class="bi bi-keyboard"></i> TYPE ITEM #
                </button>
            </div>

            <div id="modalScanCounterOuter" class="text-center mb-2">
                <span id="modalScanCounter"></span>
            </div>

            <div id="modalScanChoice" style="min-height:100px; margin-bottom:20px;" class="gtabs modal-demo">
                <div style="width:100%" class="gtab active modaltab-1">
                    <div class="text-center">
                        <input style="width:auto; display:inline-block" type="button" id="btnModalScanStart" value="Activate Barcode Reader" class="btn btn-primary btn-lg" />
                    </div>
                </div>
                <div style="width:100%" class="gtab modaltab-2">
                    <div id="modalItemNumberLookupField" class="d-flex justify-content-center align-items-center gap-2">
                        <span>TYPE ITEM NUMBER:</span>
                        <input required type="text" class="form-control" id="modalItemNumber" name="modalItemNumber" style="width:150px; display:inline;" />
                        <input style="width:100px;display:inline" type="button" id="btnModalLookup" value="Lookup" class="btn btn-secondary" />
                    </div>
                </div>
            </div>
            <div id="modalItemLoading" class="text-center" style="display:none;">
                <img src="/images/Circles-menu-3.gif" alt="Loading..." /> <!-- Adjust path if needed -->
            </div>
            <div id="barcode-container" style="display:none;"> <!-- Initially hidden -->
                <h5 class="text-center">Barcode Scanner</h5>
                <div id="barcode-scanner">
                    <video autoplay playsinline></video>
                    <canvas class="drawingBuffer"></canvas>
                </div>
                <p id="barcode-result" class="text-center">Waiting for scan...</p>
            </div>

            <form id="itemAttachmentForm">
                <!-- This hidden input can store the item number if needed separately,
                     or you can directly use #modalItemNumber.value upon submission -->
                <input type="hidden" id="finalItemNumberForSubmission" name="finalItemNumberForSubmission">

                <div class="form-box">
                    <label for="modalTitle"><i class="bi bi-tag icon"></i> Title:</label>
                    <input required type="text" class="form-control" id="modalTitle" name="title">
                </div>

                <div class="form-box">
                    <div class="price-fields">
                        <div class="price-box">
                            <label for="modalPrice"><i class="bi bi-bag icon"></i> In-Store Price</label>
                            <input required type="text" class="form-control" id="modalPrice" name="price" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$">
                        </div>
                        <div class="price-box">
                            <label for="modalPriceWithSurcharge"><i class="bi bi-globe icon"></i> Online Price</label>
                            <input required type="text" class="form-control" id="modalPriceWithSurcharge" name="pricewithsurcharge" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$">
                        </div>
                    </div>
                </div>

                <div class="form-box">
                    <label for="modalDescription"><i class="bi bi-pencil-square icon"></i> Description</label>
                    <textarea required name="description" id="modalDescription" rows="4" class="form-control"></textarea>
                </div>

                <div class="form-box">
                    <label for="modalNewPrice"><i class="bi bi-tag icon"></i> Comparison New Price (Optional)</label>
                    <input type="text" class="form-control" id="modalNewPrice" name="newprice" pattern="^\$\d{1,3}(,\d{3})*(\.\d+)?$">
                </div>

                <div class="form-box">
                    <label for="modalMoreTags"><i class="bi bi-tags icon"></i> Additional Tags (Optional)</label>
                    <input type="text" class="form-control" id="modalMoreTags" name="moretags">
                </div>

                <div class="form-box">
                    <label for="modalCondition"><i class="bi bi-box icon"></i> Item Condition</label>
                    <select class="form-select form-select-lg" id="modalCondition" name="condition">
                        <option value="GENTLY USED">üõ†Ô∏è Gently Used: Item is gently used and may have some wear.</option>
                        <option value="LIKE NEW">‚ú® Like New: Item is like new, but no longer has tags attached.</option>
                        <option value="NEW">üè∑Ô∏è NWT: Item is new and still has manufacturer tags attached.</option>
                    </select>
                </div>

                <div class="table-item"> <!-- Reusing class, adjust if needed -->
                    <div class="checkbox-container">
                        <label for="modalStatus" style="font-size:16px;">
                            <i class="bi bi-pencil-square icon"></i> Draft Mode Status?
                        </label>
                        <input type="checkbox" class="form-check-input large-checkbox" id="modalStatus" name="status" value="draft">
                    </div>
                </div>
                <div id="modalAlertPlaceholder"></div> <!-- For error messages in modal -->
            </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" form="itemAttachmentForm">Submit Item and Attach Images</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript Includes -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/beerslider/dist/BeerSlider.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/compressorjs/1.1.1/compressor.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/9.0.3/adapter.js"></script>
  <script src="https://resale.one/lib/quagga2/quagga.js"></script>
  <script src="https://resale.one/view-resources/Areas/App/Views/ECommerce/live_w_locator.js?v=22322222625523529"></script>
  <script src="https://resale.one/view-resources/Areas/App/Views/ECommerce/script2025.js?v=259er"></script>

  <script>
    // Main page script from original + integrated new JS
    const submitApiUrl = "/submit";
    const statusApiUrl = "/status/";
    const associateApiUrl = "/api/v1/item/associate_images";
    const apiKey = "secretApiKey"; // IMPORTANT: Replace

    const ASSOCIATED_JOB_IDS_KEY = 'batchUploader_associatedJobIds';
    const TRASHED_JOB_IDS_KEY = 'batchUploader_trashedJobIds';

    let jobFileMap = {};
    let sliderInstances = {};
    let itemAttachmentModalInstance;
    let quaggaScannerInitialized = false; // Flag for QuaggaJS

    // --- LocalStorage Helpers ---
    // ... (Same as previous version: getStoredJobIds, addJobIdToStorage, etc.)
    function getStoredJobIds(key) {
        const stored = localStorage.getItem(key);
        return stored ? JSON.parse(stored) : [];
    }
    function addJobIdToStorage(key, jobId) {
        let currentJobIds = getStoredJobIds(key);
        if (jobId && !currentJobIds.includes(jobId)) {
            currentJobIds.push(jobId);
            localStorage.setItem(key, JSON.stringify(currentJobIds));
        }
    }
    function removeJobIdFromStorage(key, jobId) {
        let currentJobIds = getStoredJobIds(key);
        if (jobId) {
            const index = currentJobIds.indexOf(jobId);
            if (index > -1) {
                currentJobIds.splice(index, 1);
                localStorage.setItem(key, JSON.stringify(currentJobIds));
            }
        }
    }
    function isJobAssociated(jobId) {
        return jobId ? getStoredJobIds(ASSOCIATED_JOB_IDS_KEY).includes(jobId) : false;
    }
    function isJobTrashed(jobId) {
        return jobId ? getStoredJobIds(TRASHED_JOB_IDS_KEY).includes(jobId) : false;
    }

    // --- UI Update & Sorting Functions ---
    // ... (Same as previous: updateAttachButtonStatus, applyCardState, sortImageCards)
    function updateAttachButtonStatus() {
      const anyCardsPresent = $('#results .image-card').length > 0;
      const $attachButtonContainer = $("#attachButtonContainer");
      const $attachButton = $("#attachImagesButton");

      if (anyCardsPresent) {
        $attachButtonContainer.show();
        const anySelectedForAttachment = $('#results .image-card:not(.trashed-card) .select-for-attachment:checked').length > 0;
        $attachButton.prop("disabled", !anySelectedForAttachment);
      } else {
        $attachButtonContainer.hide();
        $attachButton.prop("disabled", true);
      }
    }
    function applyCardState(jobId) {
        const $card = $(`#card-${jobId}`);
        if (!$card.length || !jobId) return;

        const associated = isJobAssociated(jobId);
        const trashed = isJobTrashed(jobId);

        $card.find('.associated-marker').toggle(associated && !trashed);
        $card.find('.trashed-marker').toggle(trashed);
        $card.toggleClass('trashed-card', trashed);

        $card.find('.select-for-attachment').prop('disabled', trashed);
        if (trashed) {
            $card.find('.select-for-attachment').prop('checked', false);
        }
    }
    function sortImageCards() {
        const $resultsContainer = $("#results");
        const $cards = $resultsContainer.children(".image-card").get();

        $cards.sort(function(a, b) {
            const $a = $(a);
            const $b = $(b);
            const aJobId = $a.data('job-id');
            const bJobId = $b.data('job-id');

            if (!aJobId || aJobId.startsWith('temp-')) return -1;
            if (!bJobId || bJobId.startsWith('temp-')) return 1;

            const aTrashed = isJobTrashed(aJobId);
            const bTrashed = isJobTrashed(bJobId);
            const aAssociated = isJobAssociated(aJobId);
            const bAssociated = isJobAssociated(bJobId);

            if (aTrashed && !bTrashed) return 1;
            if (!aTrashed && bTrashed) return -1;
            if (aTrashed && bTrashed) {
                 return ($a.data('original-filename') || '').localeCompare($b.data('original-filename') || '');
            }
            if (aAssociated && !bAssociated) return 1;
            if (!aAssociated && bAssociated) return -1;
            return ($a.data('original-filename') || '').localeCompare($b.data('original-filename') || '');
        });
        $.each($cards, function(idx, itm) { $resultsContainer.append(itm); });
        updateAttachButtonStatus();
    }

    // --- BeerSlider ---
    // ... (Same as previous: initializeOrUpdateBeerSlider)
    function initializeOrUpdateBeerSlider($card, originalImageUrl, processedImageUrl) {
      const $sliderWrapper = $card.find('.beerslider-wrapper-container');
      const originalFileName = $card.data('original-filename');
      const jobId = $card.data('job-id');
      if (!jobId) return;
      const sliderContainerId = 'beer-slider-' + jobId.replace(/-/g, '');

      $sliderWrapper.removeClass('img-placeholder').empty();
      const $beerSliderDiv = $('<div>').attr('id', sliderContainerId).addClass('beer-slider');
      const $beforeImgTag = $('<img>').attr('src', originalImageUrl).attr('alt', 'Original: ' + originalFileName);
      const $beerRevealDiv = $('<div>').addClass('beer-reveal');
      const $afterImgTag = $('<img>').attr('src', processedImageUrl + `?t=${new Date().getTime()}`).attr('alt', 'Processed: ' + originalFileName);
      $beerRevealDiv.append($afterImgTag);
      $beerSliderDiv.append($beforeImgTag).append($beerRevealDiv);
      $sliderWrapper.append($beerSliderDiv);

      let imagesLoaded = 0; const totalImages = 2;
      function onImageLoad() {
          imagesLoaded++;
          if (imagesLoaded === totalImages) {
              try {
                  if (window.BeerSlider) {
                      const sliderElement = document.getElementById(sliderContainerId);
                      if (sliderElement) {
                          sliderInstances[sliderContainerId] = new BeerSlider(sliderElement, { start: 50 });
                      }
                  } else { $sliderWrapper.addClass('img-placeholder').text('Slider library error.'); }
              } catch (e) { $sliderWrapper.addClass('img-placeholder').text('Error initializing slider.'); }
          }
      }
      $beforeImgTag.on('load', onImageLoad).on('error', () => $sliderWrapper.addClass('img-placeholder').text('Error loading original image.'));
      $afterImgTag.on('load', onImageLoad).on('error', () => $sliderWrapper.addClass('img-placeholder').text('Error loading processed image.'));
      setTimeout(() => {
          if (imagesLoaded < totalImages && !$sliderWrapper.hasClass('img-placeholder')) {
               if ($beforeImgTag.length && $beforeImgTag[0].complete && $afterImgTag.length && $afterImgTag[0].complete &&
                   $beforeImgTag[0].naturalWidth > 0 && $afterImgTag[0].naturalWidth > 0) {
                  if (imagesLoaded === 0) { onImageLoad(); onImageLoad(); } else if (imagesLoaded === 1) { onImageLoad(); }
               }
          }
      }, 700);
    }

    // --- Poll Status ---
    // ... (Same as previous: pollStatus)
    function pollStatus(jobId, cardElement) {
      const $card = $(cardElement);
      const $statusText = $card.find(".status-text");
      const $progressBar = $card.find(".progress-bar");
      const $sliderWrapper = $card.find(".beerslider-wrapper-container");
      const $refreshButton = $card.find(".refresh-btn");
      const originalImageUrl = $card.data("original-url");

      $.getJSON(statusApiUrl + jobId, function (data) {
        $statusText.text(data.status.charAt(0).toUpperCase() + data.status.slice(1) + (data.eta > 0 ? ` (ETA: ${data.eta}s)` : ""));
        $refreshButton.prop("disabled", data.status === "processing" || data.status === "queued");

        if (data.status === "done") {
          $statusText.html('<span class="badge bg-success status-badge">‚úÖ Done</span>');
          $progressBar.removeClass("progress-bar-striped progress-bar-animated").addClass("bg-success").css("width", "100%");
          if (data.processed_image_url && originalImageUrl) {
            initializeOrUpdateBeerSlider($card, originalImageUrl, data.processed_image_url);
          } else { $sliderWrapper.addClass("img-placeholder").text("Image URLs missing for slider."); }
          $card.data("processed-url", data.processed_image_url);
          $card.find(`input[name="image_choice_${jobId}"][value="processed"]`).data("url", data.processed_image_url);
          applyCardState(jobId); sortImageCards();
        } else if (data.status === "error") {
          $statusText.html(`<span class="badge bg-danger status-badge">‚ùå Error</span>: ${data.error_message || "Unknown error"}`);
          $progressBar.removeClass("progress-bar-striped progress-bar-animated").addClass("bg-danger").css("width", "100%");
          $sliderWrapper.addClass("img-placeholder").text("Processing Error: " + (data.error_message || "Unknown issue"));
          applyCardState(jobId); sortImageCards();
        } else if (data.status === "processing" || data.status === "queued") {
          $statusText.html(`<span class="badge bg-info text-dark status-badge">${data.status === "processing" ? "‚öôÔ∏è Processing..." : "‚è≥ Queued..."}</span> (ETA: ${data.eta}s)`);
          $progressBar.addClass("progress-bar-striped progress-bar-animated").removeClass("bg-success bg-danger").css("width", "50%");
          setTimeout(() => pollStatus(jobId, cardElement), 2000);
        }
      }).fail(function () {
        $statusText.html('<span class="badge bg-danger status-badge">‚ùå Error</span>: Failed to get status');
        $progressBar.removeClass("progress-bar-striped progress-bar-animated").addClass("bg-danger").css("width", "100%");
        $sliderWrapper.addClass("img-placeholder").text("Status Check Failed.");
        $refreshButton.prop("disabled", false);
        applyCardState(jobId); sortImageCards();
      });
    }

    // --- Barcode Scanner Functions (QuaggaJS) ---
    function initQuaggaScanner() {
        if (typeof Quagga === 'undefined') {
            console.error("QuaggaJS not loaded.");
            $('#barcode-result').text("Scanner library not loaded.");
            return;
        }
        if (quaggaScannerInitialized) {
            Quagga.start();
            console.log("Quagga re-started.");
            $('#barcode-container').show();
            return;
        }

        const $video = $('#barcode-scanner video')[0];
        const $barcodeContainer = $('#barcode-container');
        const $barcodeResult = $('#barcode-result');

        if (!$video) {
            console.error("Video element for scanner not found.");
            $barcodeResult.text("Scanner video element missing.");
            return;
        }
        $barcodeContainer.show(); // Show the container

        Quagga.init({
            inputStream: {
                name: "Live",
                type: "LiveStream",
                target: $video, // document.querySelector('#barcode-scanner video')
                constraints: {
                    width: { min: 640 },
                    height: { min: 480 },
                    facingMode: "environment", // "user" for front camera
                    aspectRatio: { min: 1, max: 2 }
                },
            },
            decoder: {
                readers: ["ean_reader", "ean_8_reader", "code_128_reader", "code_39_reader", "codabar_reader", "upc_reader", "upc_e_reader"],
                debug: {
                    drawBoundingBox: true,
                    showFrequency: true,
                    drawScanline: true,
                    showPattern: true
                },
                multiple: false // Process one barcode at a time
            },
            locate: true, // try to locate barcode in image
            locator: {
                patchSize: "medium", // x-small, small, medium, large, x-large
                halfSample: true
            },
            numOfWorkers: navigator.hardwareConcurrency || 4, // Use available cores
        }, function (err) {
            if (err) {
                console.error("Quagga initialization failed:", err);
                $barcodeResult.text("Scanner init failed: " + err);
                $barcodeContainer.hide();
                return;
            }
            console.log("Quagga initialization finished. Ready to start.");
            Quagga.start();
            quaggaScannerInitialized = true;
        });

        Quagga.onProcessed(function (result) {
            var drawingCtx = Quagga.canvas.ctx.overlay,
                drawingCanvas = Quagga.canvas.dom.overlay;

            if (result) {
                if (result.boxes) {
                    drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                    result.boxes.filter(function (box) {
                        return box !== result.box;
                    }).forEach(function (box) {
                        Quagga.ImageDebug.drawPath(box, { x: 0, y: 1 }, drawingCtx, { color: "green", lineWidth: 2 });
                    });
                }

                if (result.box) {
                    Quagga.ImageDebug.drawPath(result.box, { x: 0, y: 1 }, drawingCtx, { color: "#00F", lineWidth: 2 });
                }

                if (result.codeResult && result.codeResult.code) {
                    // Quagga.ImageDebug.drawPath(result.line, { x: 'x', y: 'y' }, drawingCtx, { color: 'red', lineWidth: 3 });
                }
            }
        });

        Quagga.onDetected(function (result) {
            const code = result.codeResult.code;
            console.log("Barcode detected:", code);
            $barcodeResult.text("Detected: " + code);
            $('#modalItemNumber').val(code).trigger('change'); // Update item number field
            // Optionally stop scanner, switch tab, or trigger lookup
            Quagga.stop();
            $barcodeContainer.hide(); // Hide after successful scan
            // You might want to automatically switch to the "TYPE ITEM #" tab or trigger lookup
            $('#modalTypeBtn').trigger('click'); // Switch to type tab
            // if (typeof LookupItem === "function") LookupItem(); // If LookupItem is global
        });
    }

    // Function to stop Quagga when modal is closed or scan is done
    function stopQuaggaScanner() {
        if (quaggaScannerInitialized && typeof Quagga !== 'undefined') {
            Quagga.stop();
            console.log("Quagga stopped.");
            $('#barcode-container').hide();
        }
    }


    $(document).ready(function () {
      itemAttachmentModalInstance = new bootstrap.Modal(document.getElementById('itemAttachmentModal'));

      // BG Removal Service Status (from provided snippet)
      if (typeof abp !== 'undefined' && abp.services && abp.services.app && abp.services.app.bGRemoval) {
        var _bgService = abp.services.app.bGRemoval;
        _bgService.getQueueStatus().done(function (data) {
            if (data) {
                try {
                    var obj = JSON.parse(data);
                    var statusText = obj.status || "Unknown";
                    if (Number(obj.queue_num) < 1000) {
                        $("#bgStatusBadge").removeClass("bg-info bg-danger").addClass("bg-success");
                        statusText = "Normal";
                        $("#bgremove").removeAttr("disabled");
                    } else {
                        $("#bgStatusBadge").removeClass("bg-info bg-success").addClass("bg-danger");
                        statusText = "Offline, Try Later";
                        $("#bgremove").prop("disabled", true);
                    }
                    $("#bgStatusBadge").text(
                        (obj.queue_num || 'N/A') + "/" + (obj.queue_time || 'N/A') + " (" + statusText + ")"
                    );
                } catch (e) {
                    console.error("Error parsing BG service status:", e);
                    $("#bgStatusBadge").text("Error parsing status").removeClass("bg-info").addClass("bg-warning");
                }
            } else {
                 $("#bgStatusBadge").text("No status data").removeClass("bg-info").addClass("bg-warning");
            }
        }).fail(function() {
            $("#bgStatusBadge").text("Failed to get status").removeClass("bg-info").addClass("bg-danger");
            $("#bgremove").prop("disabled", true);
        });
      } else {
        console.warn("ABP BG Removal service not available.");
        $("#bgStatusBadge").text("BG Service N/A").addClass("bg-secondary");
      }

      // Tab functionality for modal (from provided snippet, adapted)
      $('.modal-tab-trigger').click(function (e) {
          e.preventDefault();
          var tabsContainerSelector = $(this).attr('data-tabs'); // e.g., ".gtabs.modal-demo"
          var targetTabSelector = $(this).attr('data-tab');    // e.g., ".modaltab-1"

          $(tabsContainerSelector).find(".gtab").removeClass("active");
          $(tabsContainerSelector).find(targetTabSelector).addClass("active");

          // Sync button active states
          $(tabsContainerSelector).closest('.modal-body').find('.modal-tab-trigger').removeClass('btn-info styled-button').addClass('btn-light styled-button-light');
          $(this).removeClass('btn-light styled-button-light').addClass('btn-info styled-button');

          if (targetTabSelector === ".modaltab-1") { // Scan tab
              $('#barcode-container').hide(); // Hide initially, show on "Activate"
              stopQuaggaScanner(); // Stop if it was running from other tab
          } else { // Type tab
              stopQuaggaScanner();
              $('#barcode-container').hide();
          }
      });
      // Initialize default active tab button style for modal
      $('#modalScanBtn').removeClass('btn-light styled-button-light').addClass('btn-info styled-button');


      // Client-side image processing with Compressor.js (from provided snippet)
      // This attaches a change event to all file inputs on the page.
      $('input[type="file"]').on('change', function (e) {
        console.log('Compressor.js: File input changed. Compressing if images...');
        var input = this; // The file input element
        var files = Array.from(input.files);
        if (!files.length) return;

        // Check if this is the "#photos" input (if new e-commerce form has one, e.g., id="modalPhotos")
        // var isPhotosInput = (this.id === 'modalPhotos');

        let processedFiles = new Array(files.length);
        let processedCount = 0;

        for (let i = 0; i < files.length; i++) {
            (function(index) { // IIFE to capture 'index' correctly in async callbacks
                const file = files[index];
                if (!file.type.startsWith('image/')) {
                    processedFiles[index] = file; // Keep non-images as is
                    processedCount++;
                    if (processedCount === files.length) finalizeProcessedFiles();
                    return;
                }
                new Compressor(file, {
                    quality: 0.75, maxWidth: 2048, maxHeight: 2048,
                    success(result) {
                        let newFile = result;
                        if (!(result instanceof File)) { // Ensure it's a File object
                            newFile = new File([result], file.name, { type: file.type, lastModified: Date.now() });
                        }
                        processedFiles[index] = newFile;
                        processedCount++;
                        if (processedCount === files.length) finalizeProcessedFiles();
                    },
                    error(err) {
                        console.error('Compressor.js Error:', err.message, 'Original file kept:', file.name);
                        processedFiles[index] = file; // Keep original on error
                        processedCount++;
                        if (processedCount === files.length) finalizeProcessedFiles();
                    }
                });
            })(i);
        }
        function finalizeProcessedFiles() {
            var dt = new DataTransfer();
            processedFiles.forEach(f => { if(f) dt.items.add(f); }); // Add files back (ensure f is not undefined)
            input.files = dt.files; // Update the file input with processed files
            console.log('Compressor.js: Processing complete. Files in input:', Array.from(dt.files).map(f=>f.name));
            // if (isPhotosInput) { /* do something specific for #photos if needed */ }
        }
      });


      // Load existing states and sort on page load
      getStoredJobIds(ASSOCIATED_JOB_IDS_KEY).forEach(jobId => applyCardState(jobId));
      getStoredJobIds(TRASHED_JOB_IDS_KEY).forEach(jobId => applyCardState(jobId));
      sortImageCards();

      // --- Batch BG Removal Form Submission ---
      $("#uploadForm").on("submit", function (e) {
        // ... (largely same as previous, ensure IDs are updated for new card elements)
        e.preventDefault();
        const files = $("#imageFiles")[0].files;
        const model = $("#modelSelect").val();
        const postProcess = $("#postProcessCheck").is(":checked");
        if (files.length === 0) { alert("Please select image files."); return; }

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const formData = new FormData();
          formData.append("image_file", file); formData.append("api_key", apiKey);
          formData.append("model", model); formData.append("post_process", postProcess);

          const originalFileName = file.name;
          const tempJobId = `temp-${Date.now()}-${i}`;
          const tempSelectAttachId = `select-attach-${tempJobId}`;
          // Make sure radio names and label fors are also unique temporarily
          const tempRadioName = `image_choice_${tempJobId}`;

          const cardHtml = `
          <div class="col-md-4 image-card" id="card-${tempJobId}" data-original-filename="${originalFileName}">
            <div class="card">
              <div class="beerslider-wrapper-container img-placeholder">Awaiting submission...</div>
              <div class="card-body">
                <h5 class="card-title small">${originalFileName}</h5>
                <div class="progress mb-2" style="height: 10px;"><div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 10%"></div></div>
                <p class="card-text status-text"><span class="badge bg-secondary status-badge">Submitting...</span></p>
                <p class="small text-muted job-id-text">Job ID: Pending...</p>
                <div class="form-check">
                  <input class="form-check-input image-select-radio" type="radio" name="${tempRadioName}" value="original" data-url="" id="${tempRadioName}_original">
                  <label class="form-check-label small" for="${tempRadioName}_original">Use Original</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input image-select-radio" type="radio" name="${tempRadioName}" value="processed" data-url="" id="${tempRadioName}_processed" checked>
                  <label class="form-check-label small" for="${tempRadioName}_processed">Use Processed</label>
                </div>
                <div class="form-check mt-2">
                    <input class="form-check-input select-for-attachment" type="checkbox" id="${tempSelectAttachId}">
                    <label class="form-check-label small" for="${tempSelectAttachId}">Select for Item Attachment</label>
                </div>
                <div class="mt-1">
                    <span class="badge bg-info me-1 marker-badge associated-marker" style="display: none;">Associated</span>
                    <span class="badge bg-secondary marker-badge trashed-marker" style="display: none;">Trashed</span>
                </div>
              </div>
              <div class="card-footer">
                <button class="btn btn-sm btn-outline-primary refresh-btn" data-jobid="${tempJobId}" disabled>Re-process</button>
                <i class="fas fa-trash-alt trash-btn" data-jobid="${tempJobId}" title="Move to bottom/ignore"></i>
              </div>
            </div>
          </div>`;
          const $card = $(cardHtml);
          $("#results").prepend($card);

          $.ajax({
            url: submitApiUrl, method: "POST", data: formData, processData: false, contentType: false,
            success: function (data) {
              if (data.job_id) {
                const realJobId = data.job_id;
                jobFileMap[realJobId] = file;
                $card.attr("id", `card-${realJobId}`).data("job-id", realJobId);
                $card.find(".job-id-text").text(`Job ID: ${realJobId}`);
                $card.find(".refresh-btn").data("jobid", realJobId).prop("disabled", true);
                $card.find(".trash-btn").data("jobid", realJobId);

                const realRadioName = `image_choice_${realJobId}`;
                $card.find(`input[name="${tempRadioName}"]`).attr("name", realRadioName);
                $card.find(`label[for="${tempRadioName}_original"]`).attr("for", `${realRadioName}_original`);
                $card.find(`input#${tempRadioName}_original`).attr("id", `${realRadioName}_original`);
                $card.find(`label[for="${tempRadioName}_processed"]`).attr("for", `${realRadioName}_processed`);
                $card.find(`input#${tempRadioName}_processed`).attr("id", `${realRadioName}_processed`);

                const $selectAttachInput = $card.find(`#${tempSelectAttachId}`);
                const newSelectAttachId = `select-attach-${realJobId}`;
                $selectAttachInput.attr('id', newSelectAttachId).next('label').attr('for', newSelectAttachId);

                $card.data("original-url", data.original_image_url);
                $card.find(`input[name="${realRadioName}"][value="original"]`).data("url", data.original_image_url);
                $card.find(".beerslider-wrapper-container.img-placeholder").html(`Original: Waiting...<br>Processed: ${data.status || 'Queued'}`);
                pollStatus(realJobId, $card[0]); applyCardState(realJobId); sortImageCards();
              } else { /* Error handling */ }
            }, error: function (xhr) { /* Error handling */ }
          });
        }
        $("#imageFiles").val(""); updateAttachButtonStatus();
      });

      // --- Refresh, Trash, Select for Attachment ---
      // ... (Event handlers for .refresh-btn, .trash-btn, .select-for-attachment are largely same as previous version)
      // Ensure job IDs are correctly updated in these handlers if a card's job ID changes (e.g., on re-process)
       $("#results").on("click", ".refresh-btn", function () {
          const jobIdToRefresh = $(this).data("jobid");
          // ... (rest of refresh logic from previous version, ensuring IDs are correctly updated)
          // It should create a new request and potentially update the card with a new job ID if returned.
          // This is complex because it involves updating all data-jobid and name/id attributes on the card.
          // The previous detailed example for re-process is a good reference.
          // For brevity here, assume it's similar to the one from the last full working example.
          // Key is that after a new job ID is obtained, pollStatus, applyCardState, sortImageCards are called.
          console.log("Re-processing for job (or temp ID):", jobIdToRefresh);
          // Add full re-process AJAX call here, similar to initial submit but for an existing card/file.
      });
      $("#results").on("click", ".trash-btn", function () {
        const jobId = $(this).data("jobid");
        if (!jobId || jobId.startsWith('temp-')) return;
        if (isJobTrashed(jobId)) { removeJobIdFromStorage(TRASHED_JOB_IDS_KEY, jobId); }
        else { addJobIdToStorage(TRASHED_JOB_IDS_KEY, jobId); }
        applyCardState(jobId); sortImageCards();
      });
      $("#results").on("change", ".select-for-attachment", function () { updateAttachButtonStatus(); });


      // --- "Attach Selected to Item" Button & Modal Logic ---
      $("#attachImagesButton").on("click", function () {
        const $selectedCheckboxes = $('#results .image-card:not(.trashed-card) .select-for-attachment:checked');
        if ($selectedCheckboxes.length === 0) { alert("Please select images."); return; }

        const $thumbnailsContainer = $("#selectedImagesThumbnailsContainer").empty();
        $("#modalAlertPlaceholder").empty();
        // Reset e-commerce form fields in modal (optional, but good practice)
        $('#itemAttachmentForm')[0].reset();
        $('#barcode-result').text("Waiting for scan...");
        $('#modalItemNumber').val(''); // Clear item number field

        $selectedCheckboxes.each(function () {
          const $card = $(this).closest(".image-card");
          const jobId = $card.data("job-id");
          const originalFileName = $card.data("original-filename");
          const selectedVersion = $card.find(`input[name="image_choice_${jobId}"]:checked`).val();
          let imageUrl = $card.find(`input[name="image_choice_${jobId}"][value="${selectedVersion}"]`).data("url");

          if (jobId && !jobId.startsWith("temp-") && imageUrl) {
            const thumbHtml = `
              <div class="modal-thumbnail-item" data-job-id="${jobId}" data-image-url="${imageUrl}" data-version="${selectedVersion}">
                <img src="${imageUrl}" alt="${originalFileName}">
                <button type="button" class="remove-img-btn" title="Remove this image">√ó</button>
              </div>`;
            $thumbnailsContainer.append(thumbHtml);
          }
        });

        if ($thumbnailsContainer.children().length > 0) {
            // Ensure default tab state for modal tabs
            $('#modalScanBtn').trigger('click'); // Click the first tab trigger to set initial state
            itemAttachmentModalInstance.show();
        } else { alert("Selected images are not ready or have no URL."); }
      });

      // Remove image from modal thumbnail view
      $("#selectedImagesThumbnailsContainer").on("click", ".remove-img-btn", function() {
          $(this).closest(".modal-thumbnail-item").remove();
      });

      // Activate barcode scanner button in modal
      $('#btnModalScanStart').on('click', function() {
          initQuaggaScanner();
      });

      // Stop scanner when modal is hidden
      $('#itemAttachmentModal').on('hidden.bs.modal', function () {
          stopQuaggaScanner();
      });


      // Modal Form Submission (E-commerce form + selected images)
      $("#itemAttachmentForm").on("submit", function(e) {
        e.preventDefault();
        const itemNumber = $("#modalItemNumber").val().trim(); // Get item number from modal's form
        $('#finalItemNumberForSubmission').val(itemNumber); // Store it if needed by name

        // Basic validation for item number (add more as needed)
        if (!itemNumber) {
          $("#modalAlertPlaceholder").html('<div class="alert alert-danger" role="alert">Item Number is required.</div>');
          $('#modalItemNumber').focus();
          return;
        }
        $("#modalAlertPlaceholder").empty();

        const formData = new FormData(this); // Gathers all form data from itemAttachmentForm

        const attachedImages = [];
        $("#selectedImagesThumbnailsContainer .modal-thumbnail-item").each(function() {
            const $thumb = $(this);
            attachedImages.push({
                job_id: $thumb.data("job-id"),
                image_url: $thumb.data("image-url"),
                selected_version: $thumb.data("version")
                // original_filename could be added if needed by backend
            });
        });

        if (attachedImages.length === 0) {
            $("#modalAlertPlaceholder").html('<div class="alert alert-warning" role="alert">No images selected for attachment.</div>');
            return;
        }

        // Append images to formData (as JSON string or individual params)
        formData.append("attached_images_json", JSON.stringify(attachedImages));

        // Log data for debugging
        console.log("Submitting Item Data to Backend:");
        for (let pair of formData.entries()) { console.log(pair[0]+ ': ' + pair[1]); }

        // --- SIMULATE BACKEND CALL for item creation/update + image association ---
        // Replace this with your actual $.ajax call to 'associateApiUrl' or a new endpoint
        // This endpoint would now handle the full item form data + the image list.
        // $.ajax({
        //   url: associateApiUrl, // Or a new endpoint like /api/v1/item/create_with_images
        //   method: "POST",
        //   data: formData, // Send FormData directly
        //   processData: false,
        //   contentType: false,
        //   success: function(response) {
        //     console.log("Item & Image Association successful:", response);
            const jobIdsMarked = [];
            attachedImages.forEach(img => {
                addJobIdToStorage(ASSOCIATED_JOB_IDS_KEY, img.job_id);
                removeJobIdFromStorage(TRASHED_JOB_IDS_KEY, img.job_id);
                applyCardState(img.job_id);
                $(`#card-${img.job_id} .select-for-attachment`).prop('checked', false);
                jobIdsMarked.push(img.job_id);
            });
            itemAttachmentModalInstance.hide();
            sortImageCards();
            alert(`Item "${$('#modalTitle').val()}" (Number: ${itemNumber}) and ${jobIdsMarked.length} images submitted.`);
        //   },
        //   error: function(xhr) {
        //     let errorMsg = "Failed to submit item and associate images.";
        //     if (xhr.responseJSON && xhr.responseJSON.error) { errorMsg = xhr.responseJSON.error; }
        //     $("#modalAlertPlaceholder").html(`<div class="alert alert-danger" role="alert">${errorMsg}</div>`);
        //   }
        // });
        // --- END SIMULATION ---
      });

      // Inline function calls from new HTML (ensure these are defined if not in provided JS files)
      // Mockups if not defined elsewhere, you should have these in your script2025.js etc.
      if (typeof window.scanActive !== 'function') { window.scanActive = function() { console.log("scanActive called - ensure it's defined.");}; }
      if (typeof window.typeActive !== 'function') { window.typeActive = function() { console.log("typeActive called - ensure it's defined.");}; }
      if (typeof window.disableScan !== 'function') { window.disableScan = function() { console.log("disableScan called - ensure it's defined.");}; }
      if (typeof window.LookupItem !== 'function') { window.LookupItem = function() { console.log("LookupItem called - ensure it's defined."); $('#modalItemLoading').hide(); }; }
      if (typeof window.CurrencyFormatted !== 'function') { window.CurrencyFormatted = function(input) { console.log("CurrencyFormatted called for input:", input.id);}; }
      if (typeof window.startScanner !== 'function') {
          window.startScanner = function() {
              console.log("startScanner (main page) called - ensure it's defined or link to modal's scanner.");
              // This was for a main page scanner, modal uses #btnModalScanStart
          };
      }
      // Trigger for modal item lookup
      $('#btnModalLookup').on('click', function() {
          if (typeof LookupItem === "function") {
              $('#modalItemLoading').show(); // Show loading indicator
              LookupItem(); // Assuming LookupItem uses value from #modalItemNumber
          } else {
              console.warn("LookupItem function not defined for modal.");
          }
      });


    }); // End document.ready
  </script>
</body>
</html>
