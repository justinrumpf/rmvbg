<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Batch Background Removal 5</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Add Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/beerslider/dist/BeerSlider.css"
  />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    .image-card {
      margin-bottom: 20px;
      transition: opacity 0.3s ease-in-out; /* For visual feedback on trashing */
    }
    .image-card.trashed-card {
        opacity: 0.6; /* Visually indicate trashed */
    }
    .beerslider-wrapper-container {
      width: 100%;
      aspect-ratio: 1 / 1;
      border: 1px solid #ccc;
      position: relative;
    }
    .beerslider-wrapper-container.img-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: #f0f0f0;
      color: #aaa;
      font-size: 0.9em;
      text-align: center;
      height: 100%;
    }
    .beer-slider img {
      display: block;
      max-width: 100%;
      height: auto;
      object-fit: contain;
    }
    .status-badge, .marker-badge {
      font-size: 0.8em;
    }
    .card-footer {
      background-color: #f8f9fa;
      display: flex;
      justify-content: space-between; /* Align reprocess and trash */
      align-items: center;
    }
    .trash-btn {
        color: #dc3545; /* Bootstrap danger color */
        cursor: pointer;
    }
    .trash-btn:hover {
        color: #bd2130;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>Batch Image Background Removal</h1>
      <button id="attachImagesButton" class="btn btn-info btn-lg" disabled>
        Attach Selected to Item
      </button>
    </div>

    <form id="uploadForm" class="mb-4">
      <div class="mb-3">
        <label for="imageFiles" class="form-label"
          >Select Images (PNG, JPG, WebP):</label
        >
        <input
          type="file"
          class="form-control"
          id="imageFiles"
          multiple
          accept="image/png, image/jpeg, image/webp"
        />
      </div>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="modelSelect" class="form-label">Model:</label>
          <select id="modelSelect" class="form-select">
            <option value="u2net" selected>U2Net (General Purpose)</option>
            <option value="u2netp">U2Netp (Lightweight)</option>
            <option value="u2net_human_seg">U2Net Human Segmentation</option>
            <option value="u2net_cloth_seg">U2Net Cloth Segmentation</option>
            <option value="silueta">Silueta (Alternative to U2Net)</option>
            <option value="isnet-general-use">IS-Net General Use</option>
            <option value="isnet-anime">IS-Net Anime</option>
          </select>
        </div>
        <div class="col-md-4 mb-3 d-flex align-items-end">
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="postProcessCheck"
            />
            <label class="form-check-label" for="postProcessCheck">
              Enable Post-Processing (Alpha Matting)
            </label>
          </div>
        </div>
        <div class="col-md-4 mb-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">
            Process Selected Images
          </button>
        </div>
      </div>
    </form>

    <hr />
    <div id="results" class="row mt-4">
      <!-- Image cards will be appended here -->
    </div>
  </div>

  <!-- Item Attachment Modal -->
  <div class="modal fade" id="itemAttachmentModal" tabindex="-1" aria-labelledby="itemAttachmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="itemAttachmentModalLabel">Attach Images to Item</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <h6>Selected Images for Attachment:</h6>
          <ul id="selectedImagesListModal" class="list-group mb-3"></ul>
          <form id="itemAttachmentForm">
            <div class="mb-3">
              <label for="itemNumberInput" class="form-label">Item Number:</label>
              <input type="text" class="form-control" id="itemNumberInput" required>
            </div>
            <div id="modalAlertPlaceholder"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" form="itemAttachmentForm">Submit to Item</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/beerslider/dist/BeerSlider.min.js"></script>

  <script>
    const submitApiUrl = "/submit";
    const statusApiUrl = "/status/";
    const associateApiUrl = "/api/v1/item/associate_images";
    const apiKey = "secretApiKey"; // Replace with secure handling

    const ASSOCIATED_JOB_IDS_KEY = 'batchUploader_associatedJobIds';
    const TRASHED_JOB_IDS_KEY = 'batchUploader_trashedJobIds';

    let jobFileMap = {};
    let sliderInstances = {};
    let itemAttachmentModalInstance;

    // --- LocalStorage Helpers ---
    function getStoredJobIds(key) {
        const stored = localStorage.getItem(key);
        return stored ? JSON.parse(stored) : [];
    }
    function addJobIdToStorage(key, jobId) {
        let currentJobIds = getStoredJobIds(key);
        if (!currentJobIds.includes(jobId)) {
            currentJobIds.push(jobId);
            localStorage.setItem(key, JSON.stringify(currentJobIds));
        }
    }
    function removeJobIdFromStorage(key, jobId) {
        let currentJobIds = getStoredJobIds(key);
        const index = currentJobIds.indexOf(jobId);
        if (index > -1) {
            currentJobIds.splice(index, 1);
            localStorage.setItem(key, JSON.stringify(currentJobIds));
        }
    }
    function isJobAssociated(jobId) {
        return getStoredJobIds(ASSOCIATED_JOB_IDS_KEY).includes(jobId);
    }
    function isJobTrashed(jobId) {
        return getStoredJobIds(TRASHED_JOB_IDS_KEY).includes(jobId);
    }

    // --- UI Update & Sorting Functions ---
    function updateAttachButtonStatus() {
      const anySelectedForAttachment = $('#results .image-card:not(.trashed-card) .select-for-attachment:checked').length > 0;
      $("#attachImagesButton").prop("disabled", !anySelectedForAttachment);
    }

    function applyCardState(jobId) {
        const $card = $(`#card-${jobId}`);
        if (!$card.length) return;

        const associated = isJobAssociated(jobId);
        const trashed = isJobTrashed(jobId);

        $card.find('.associated-marker').toggle(associated && !trashed);
        $card.find('.trashed-marker').toggle(trashed);
        $card.toggleClass('trashed-card', trashed);

        // Disable selection if trashed
        $card.find('.select-for-attachment').prop('disabled', trashed);
        if (trashed) {
            $card.find('.select-for-attachment').prop('checked', false);
        }
    }

    function sortImageCards() {
        const $resultsContainer = $("#results");
        const $cards = $resultsContainer.children(".image-card").get();

        $cards.sort(function(a, b) {
            const $a = $(a);
            const $b = $(b);
            const aJobId = $a.data('job-id');
            const bJobId = $b.data('job-id');

            // Handle cases where job-id might not be set yet (temp cards)
            if (!aJobId || aJobId.startsWith('temp-')) return -1; // Keep temp cards at top initially
            if (!bJobId || bJobId.startsWith('temp-')) return 1;

            const aTrashed = isJobTrashed(aJobId);
            const bTrashed = isJobTrashed(bJobId);
            const aAssociated = isJobAssociated(aJobId);
            const bAssociated = isJobAssociated(bJobId);

            if (aTrashed && !bTrashed) return 1;  // a to bottom
            if (!aTrashed && bTrashed) return -1; // b to bottom

            // If both or neither are trashed, sort by association
            if (!aTrashed && !bTrashed) { // Both not trashed
                if (aAssociated && !bAssociated) return 1; // a (associated) after b (not associated)
                if (!aAssociated && bAssociated) return -1; // b (associated) after a (not associated)
            }
            // If both trashed, or both associated (and not trashed), or both not associated (and not trashed),
            // maintain original relative order or sort by filename/ID (optional)
            // For simplicity, let's try to maintain original order or use job ID for tie-breaking
            const aOriginalName = $a.data('original-filename') || '';
            const bOriginalName = $b.data('original-filename') || '';
            return aOriginalName.localeCompare(bOriginalName); // Default sort by name
        });

        $.each($cards, function(idx, itm) { $resultsContainer.append(itm); });
        updateAttachButtonStatus(); // After sorting, button state might need update
    }

    function initializeOrUpdateBeerSlider($card, originalImageUrl, processedImageUrl) {
      // ... (BeerSlider logic remains the same)
      const $sliderWrapper = $card.find('.beerslider-wrapper-container');
      const originalFileName = $card.data('original-filename');
      const sliderContainerId = 'beer-slider-' + $card.data('job-id').replace(/-/g, '');

      if (sliderInstances[sliderContainerId]) { /* ... */ }
      $sliderWrapper.removeClass('img-placeholder').empty();

      const $beerSliderDiv = $('<div>').attr('id', sliderContainerId).addClass('beer-slider');
      const $beforeImgTag = $('<img>').attr('src', originalImageUrl).attr('alt', 'Original: ' + originalFileName);
      const $beerRevealDiv = $('<div>').addClass('beer-reveal');
      const $afterImgTag = $('<img>').attr('src', processedImageUrl + `?t=${new Date().getTime()}`).attr('alt', 'Processed: ' + originalFileName);

      $beerRevealDiv.append($afterImgTag);
      $beerSliderDiv.append($beforeImgTag).append($beerRevealDiv);
      $sliderWrapper.append($beerSliderDiv);

      let imagesLoaded = 0;
      const totalImages = 2;

      function onImageLoad() {
          imagesLoaded++;
          if (imagesLoaded === totalImages) {
              try {
                  if (window.BeerSlider) {
                      const sliderElement = document.getElementById(sliderContainerId);
                      const instance = new BeerSlider(sliderElement, { start: 50 });
                      sliderInstances[sliderContainerId] = instance;
                  } else {
                       $sliderWrapper.addClass('img-placeholder').text('Slider library error.');
                  }
              } catch (e) {
                  console.error("Error initializing BeerSlider for #" + sliderContainerId + ":", e);
                  $sliderWrapper.addClass('img-placeholder').text('Error initializing slider.');
              }
          }
      }
      $beforeImgTag.on('load', onImageLoad).on('error', () => $sliderWrapper.addClass('img-placeholder').text('Error loading original image.'));
      $afterImgTag.on('load', onImageLoad).on('error', () => $sliderWrapper.addClass('img-placeholder').text('Error loading processed image.'));
      
      setTimeout(() => {
          if (imagesLoaded < totalImages && !$sliderWrapper.hasClass('img-placeholder')) {
               if ($beforeImgTag[0].complete && $afterImgTag[0].complete && $beforeImgTag[0].naturalWidth > 0 && $afterImgTag[0].naturalWidth > 0) {
                  if (imagesLoaded === 0) { onImageLoad(); onImageLoad(); }
                  else if (imagesLoaded === 1) { onImageLoad(); }
               }
          }
      }, 700);
    }

    function pollStatus(jobId, cardElement) {
      const $card = $(cardElement);
      // ... (Rest of pollStatus remains largely the same)
      // Key addition: call applyCardState and sortImageCards on "done"
      const $statusText = $card.find(".status-text");
      const $progressBar = $card.find(".progress-bar");
      const $sliderWrapper = $card.find(".beerslider-wrapper-container");
      const $refreshButton = $card.find(".refresh-btn");
      const originalImageUrl = $card.data("original-url");

      $.getJSON(statusApiUrl + jobId, function (data) {
        $statusText.text(data.status.charAt(0).toUpperCase() + data.status.slice(1) + (data.eta > 0 ? ` (ETA: ${data.eta}s)` : ""));
        $refreshButton.prop("disabled", data.status === "processing" || data.status === "queued");

        if (data.status === "done") {
          $statusText.html('<span class="badge bg-success status-badge">‚úÖ Done</span>');
          $progressBar.removeClass("progress-bar-striped progress-bar-animated").addClass("bg-success").css("width", "100%");
          if (data.processed_image_url && originalImageUrl) {
            initializeOrUpdateBeerSlider($card, originalImageUrl, data.processed_image_url);
          } else {
            $sliderWrapper.addClass("img-placeholder").text("Image URLs missing for slider.");
          }
          $card.data("processed-url", data.processed_image_url);
          $card.find('input[name^="image_choice_"][value="processed"]').data("url", data.processed_image_url);
          applyCardState(jobId);
          sortImageCards();
        } else if (data.status === "error") {
          $statusText.html(`<span class="badge bg-danger status-badge">‚ùå Error</span>: ${data.error_message || "Unknown error"}`);
          $progressBar.removeClass("progress-bar-striped progress-bar-animated").addClass("bg-danger").css("width", "100%");
          $sliderWrapper.addClass("img-placeholder").text("Processing Error: " + (data.error_message || "Unknown issue"));
          applyCardState(jobId); // Even on error, apply state (e.g. if it was already trashed)
          sortImageCards();
        } else if (data.status === "processing" || data.status === "queued") {
          $statusText.html(`<span class="badge bg-info text-dark status-badge">${data.status === "processing" ? "‚öôÔ∏è Processing..." : "‚è≥ Queued..."}</span> (ETA: ${data.eta}s)`);
          $progressBar.addClass("progress-bar-striped progress-bar-animated").removeClass("bg-success bg-danger").css("width", "50%");
          setTimeout(() => pollStatus(jobId, cardElement), 2000);
        }
      }).fail(function () {
        $statusText.html('<span class="badge bg-danger status-badge">‚ùå Error</span>: Failed to get status');
        $progressBar.removeClass("progress-bar-striped progress-bar-animated").addClass("bg-danger").css("width", "100%");
        $sliderWrapper.addClass("img-placeholder").text("Status Check Failed.");
        $refreshButton.prop("disabled", false);
        applyCardState(jobId);
        sortImageCards();
      });
    }

    $(document).ready(function () {
      itemAttachmentModalInstance = new bootstrap.Modal(document.getElementById('itemAttachmentModal'));
      // Initial load: apply states and sort
      $('#results .image-card').each(function() { // Should be empty initially, but good for future
          const jobId = $(this).data('job-id');
          if (jobId) applyCardState(jobId);
      });
      sortImageCards();
      updateAttachButtonStatus();

      $("#uploadForm").on("submit", function (e) {
        e.preventDefault();
        const files = $("#imageFiles")[0].files;
        // ... (rest of form submission)
        if (files.length === 0) { alert("Please select one or more image files."); return; }
        const model = $("#modelSelect").val();
        const postProcess = $("#postProcessCheck").is(":checked");

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const formData = new FormData();
          formData.append("image_file", file);
          formData.append("api_key", apiKey);
          formData.append("model", model);
          formData.append("post_process", postProcess);

          const originalFileName = file.name;
          const tempJobId = `temp-${Date.now()}-${i}`;
          const selectAttachId = `select-attach-${tempJobId}`;

          const cardHtml = `
          <div class="col-md-4 image-card" id="card-${tempJobId}" data-original-filename="${originalFileName}">
            <div class="card">
              <div class="beerslider-wrapper-container img-placeholder">
                Original: Awaiting submission<br>Processed: Queued
              </div>
              <div class="card-body">
                <h5 class="card-title small">${originalFileName}</h5>
                <div class="progress mb-2" style="height: 10px;">
                  <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 10%"></div>
                </div>
                <p class="card-text status-text"><span class="badge bg-secondary status-badge">‚è≥ Submitting...</span></p>
                <p class="small text-muted job-id-text">Job ID: Pending...</p>
                <div class="form-check">
                  <input class="form-check-input image-select-radio" type="radio" name="image_choice_${tempJobId}" value="original" data-url="">
                  <label class="form-check-label small">Use Original</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input image-select-radio" type="radio" name="image_choice_${tempJobId}" value="processed" data-url="" checked>
                  <label class="form-check-label small">Use Processed</label>
                </div>
                <div class="form-check mt-2">
                    <input class="form-check-input select-for-attachment" type="checkbox" value="" id="${selectAttachId}">
                    <label class="form-check-label small" for="${selectAttachId}">Select for Item Attachment</label>
                </div>
                <div class="mt-1">
                    <span class="badge bg-info me-1 marker-badge associated-marker" style="display: none;">Associated</span>
                    <span class="badge bg-secondary marker-badge trashed-marker" style="display: none;">Trashed</span>
                </div>
              </div>
              <div class="card-footer">
                <button class="btn btn-sm btn-outline-primary refresh-btn" data-jobid="${tempJobId}" disabled>Re-process</button>
                <i class="fas fa-trash-alt trash-btn" title="Move to bottom/ignore"></i>
              </div>
            </div>
          </div>`;
          const $card = $(cardHtml);
          $("#results").prepend($card); // Prepend new cards so they appear at the top initially

          $.ajax({
            url: submitApiUrl, method: "POST", data: formData, processData: false, contentType: false,
            success: function (data) {
              if (data.job_id) {
                jobFileMap[data.job_id] = file;
                const newSelectAttachId = `select-attach-${data.job_id}`;
                $card.attr("id", `card-${data.job_id}`);
                $card.data("job-id", data.job_id);
                $card.data("original-url", data.original_image_url);
                $card.find(".job-id-text").text(`Job ID: ${data.job_id}`);
                $card.find(".refresh-btn").data("jobid", data.job_id).prop("disabled", true);
                $card.find(".trash-btn").data("jobid", data.job_id); // Set jobid for trash btn
                $card.find('input[name^="image_choice_"]').attr("name", `image_choice_${data.job_id}`);
                $card.find('input[id^="select-attach-"]').attr('id', newSelectAttachId).next('label').attr('for', newSelectAttachId);
                $card.find('input[value="original"]').data("url", data.original_image_url);
                $card.find(".beerslider-wrapper-container.img-placeholder")
                  .html(`Original: Waiting for server URL<br>Processed: ${data.status === "queued" ? "Queued" : "Processing..."}`);
                pollStatus(data.job_id, $card[0]);
                applyCardState(data.job_id); // Apply initial state (likely not associated/trashed yet)
                sortImageCards(); // Sort after getting job_id
              } else { /* ... error handling ... */ 
                $card.find(".status-text").html('<span class="badge bg-danger status-badge">‚ùå Submission Error</span>');
                $card.find(".progress-bar").addClass("bg-danger").css("width", "100%");
                $card.find(".beerslider-wrapper-container.img-placeholder").text("Submission Error.");
              }
            },
            error: function (xhr) { /* ... error handling ... */
                let errorMsg = "Submission failed.";
                if (xhr.responseJSON && xhr.responseJSON.error) { errorMsg = xhr.responseJSON.error; }
                else if (xhr.responseJSON && xhr.responseJSON.detail) {
                  if (Array.isArray(xhr.responseJSON.detail)) { errorMsg = xhr.responseJSON.detail.map(d => `${d.loc.join(".")} - ${d.msg}`).join("; "); }
                  else { errorMsg = xhr.responseJSON.detail; }
                }
                $card.find(".status-text").html(`<span class="badge bg-danger status-badge">‚ùå Error</span>: ${errorMsg}`);
                $card.find(".progress-bar").addClass("bg-danger").css("width", "100%");
                $card.find(".beerslider-wrapper-container.img-placeholder").text("AJAX Submission Error.");
            },
          });
        }
        $("#imageFiles").val("");
        // sortImageCards(); // Sort immediately after adding temp cards
        updateAttachButtonStatus();
      });

      $("#results").on("click", ".refresh-btn", function () {
          const jobIdToRefresh = $(this).data("jobid");
          const $card = $(`#card-${jobIdToRefresh}`);
          // ... (re-processing logic)
          // Important: After re-processing gets a NEW job ID,
          // the old job ID's "trashed" or "associated" status is effectively orphaned.
          // The new job ID starts fresh.
          if (!jobFileMap[jobIdToRefresh]) { alert("Original file not found for re-processing."); return; }
          const originalFile = jobFileMap[jobIdToRefresh];
          const model = $("#modelSelect").val();
          const postProcess = $("#postProcessCheck").is(":checked");
          const formData = new FormData();
          // ... append to formData ...
          formData.append("image_file", originalFile);
          formData.append("api_key", apiKey);
          formData.append("model", model);
          formData.append("post_process", postProcess);

          $card.find(".status-text").html('<span class="badge bg-secondary status-badge">üîÑ Re-submitting...</span>');
          // ... reset card UI for re-processing ...
          $card.find(".progress-bar").removeClass("bg-success bg-danger").addClass("progress-bar-striped progress-bar-animated").css("width", "10%");
          $card.find(".beerslider-wrapper-container").addClass("img-placeholder").empty().text("Re-processing... (Slider will refresh)");
          $card.find(".refresh-btn").prop("disabled", true);
          $card.data("processed-url", null);
          $card.find('input[value="processed"]').data("url", null);
          $card.find('.select-for-attachment').prop('checked', false); // Uncheck
          // Keep existing markers for the old job ID until new job ID is confirmed
          // $card.find('.associated-marker, .trashed-marker').hide();
          // $card.removeClass('trashed-card');

          $.ajax({
              url: submitApiUrl, method: "POST", data: formData, processData: false, contentType: false,
              success: function (newData) {
                  if (newData.job_id) {
                      const oldJobId = $card.data('job-id');
                      // If job ID changes, the old one's state (trashed/associated) is effectively gone for this card
                      // We might want to remove from localStorage if job ID truly changes and old one is invalid.
                      // For now, we assume re-processing might reuse or give new job ID.
                      if (oldJobId !== newData.job_id) {
                        delete jobFileMap[oldJobId]; // Remove old mapping if ID changed
                        // Optional: remove oldJobId from TRASHED_JOB_IDS_KEY and ASSOCIATED_JOB_IDS_KEY if it's truly a replacement
                        // removeJobIdFromStorage(TRASHED_JOB_IDS_KEY, oldJobId);
                        // removeJobIdFromStorage(ASSOCIATED_JOB_IDS_KEY, oldJobId);
                      }
                      jobFileMap[newData.job_id] = originalFile;

                      const newSelectAttachId = `select-attach-${newData.job_id}`;
                      $card.attr("id", `card-${newData.job_id}`);
                      $card.data("job-id", newData.job_id);
                      $card.data("original-url", newData.original_image_url);
                      $card.find(".job-id-text").text(`Job ID: ${newData.job_id}`);
                      $card.find(".refresh-btn").data("jobid", newData.job_id);
                      $card.find(".trash-btn").data("jobid", newData.job_id); // Update trash btn
                      $card.find('input[name^="image_choice_"]').attr("name", `image_choice_${newData.job_id}`);
                      $card.find('input[id^="select-attach-temp"]').attr('id', newSelectAttachId).next('label').attr('for', newSelectAttachId);


                      $card.find('input[value="original"]').data("url", newData.original_image_url);
                      $card.find(".beerslider-wrapper-container.img-placeholder").html(`Original: Waiting for server URL<br>Processed: ${newData.status === "queued" ? "Queued" : "Processing..."}`);
                      pollStatus(newData.job_id, $card[0]); // This will call applyCardState & sort
                  } else { /* ... error handling ... */
                      $card.find(".status-text").html('<span class="badge bg-danger status-badge">‚ùå Re-submission Error</span>');
                      $card.find(".refresh-btn").prop("disabled", false);
                  }
              },
              error: function () { /* ... error handling ... */
                  $card.find(".status-text").html('<span class="badge bg-danger status-badge">‚ùå Re-submission Failed</span>');
                  $card.find(".refresh-btn").prop("disabled", false);
              }
          });
          updateAttachButtonStatus();
      });

      // When "Select for Item Attachment" checkbox changes
      $("#results").on("change", ".select-for-attachment", function () {
        updateAttachButtonStatus();
      });

      // Trash button click
      $("#results").on("click", ".trash-btn", function () {
        const jobId = $(this).data("jobid");
        if (!jobId || jobId.startsWith('temp-')) return;

        if (isJobTrashed(jobId)) {
            removeJobIdFromStorage(TRASHED_JOB_IDS_KEY, jobId); // Untrash
        } else {
            addJobIdToStorage(TRASHED_JOB_IDS_KEY, jobId); // Trash
            // If trashing, also remove from associated list if present
            // removeJobIdFromStorage(ASSOCIATED_JOB_IDS_KEY, jobId); // Optional: trashing overrides association display
        }
        applyCardState(jobId);
        sortImageCards();
        updateAttachButtonStatus();
      });


      $("#attachImagesButton").on("click", function () {
        const $selectedCheckboxes = $('#results .image-card:not(.trashed-card) .select-for-attachment:checked');
        // ... (Modal population logic remains the same)
        if ($selectedCheckboxes.length === 0) {
          alert("Please select at least one non-trashed image to attach.");
          return;
        }
        // ...
        const $listElement = $("#selectedImagesListModal").empty();
        $("#modalAlertPlaceholder").empty();
        $("#itemNumberInput").val('');
        let imagesForModal = [];

        $selectedCheckboxes.each(function () {
          const $card = $(this).closest(".image-card");
          const jobId = $card.data("job-id");
          const originalFileName = $card.data("original-filename");
          const selectedVersion = $card.find(`input[name="image_choice_${jobId}"]:checked`).val();
          let imageUrl = $card.find(`input[name="image_choice_${jobId}"][value="${selectedVersion}"]`).data("url");
          
          if (jobId && !jobId.startsWith("temp-") && imageUrl) {
            imagesForModal.push({ jobId: jobId, url: imageUrl, fileName: originalFileName, version: selectedVersion });
            $listElement.append( /* ... */ );
          }
        });
        
        if (imagesForModal.length > 0) {
            itemAttachmentModalInstance.show();
        } else {
            alert("Selected images are not ready or have no URL. Please wait for processing to complete.");
        }
      });

      $("#itemAttachmentForm").on("submit", function(e) {
        e.preventDefault();
        // ... (Modal submission logic remains the same)
        const itemNumber = $("#itemNumberInput").val().trim();
        if (!itemNumber) { /* ... */ return; }
        $("#modalAlertPlaceholder").empty();

        const imagesToAssociate = [];
        const jobIdsToMarkAssociated = [];

        $("#selectedImagesListModal .list-group-item").each(function() {
            const jobId = $(this).data("job-id");
            // ... (get image details)
            const $card = $(`#card-${jobId}`);
            const originalFileName = $card.data("original-filename");
            const selectedVersion = $card.find(`input[name="image_choice_${jobId}"]:checked`).val();
            const url = $card.find(`input[name="image_choice_${jobId}"][value="${selectedVersion}"]`).data("url");

            if (jobId && url) {
                imagesToAssociate.push({ job_id: jobId, image_url: url, original_filename: originalFileName, selected_version: selectedVersion });
                jobIdsToMarkAssociated.push(jobId);
            }
        });
        // ...

        // SIMULATE BACKEND CALL
        console.log("Submitting to backend:", { item_number: itemNumber, images: imagesToAssociate });
        // $.ajax({ /* ... */
        //   success: function(response) {
            jobIdsToMarkAssociated.forEach(jobId => {
                addJobIdToStorage(ASSOCIATED_JOB_IDS_KEY, jobId);
                removeJobIdFromStorage(TRASHED_JOB_IDS_KEY, jobId); // Associating untrashes
                applyCardState(jobId);
                $(`#card-${jobId} .select-for-attachment`).prop('checked', false);
            });
            itemAttachmentModalInstance.hide();
            sortImageCards(); // Re-sort after association
            updateAttachButtonStatus();
            alert(`Images successfully associated with item number: ${itemNumber}`);
        //   }, /* ... error ... */
        // });
      });
    }); // End document.ready
  </script>
</body>
</html>
