<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Batch Background Removal 4</title>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/beerslider/dist/BeerSlider.css"
  />
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    .image-card {
      margin-bottom: 20px;
    }
    .beerslider-wrapper-container {
      width: 100%;
      aspect-ratio: 1 / 1;
      border: 1px solid #ccc;
      position: relative;
    }
    .beerslider-wrapper-container.img-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background-color: #f0f0f0;
      color: #aaa;
      font-size: 0.9em;
      text-align: center;
      height: 100%;
    }
    .beer-slider img {
      display: block;
      max-width: 100%;
      height: auto;
      object-fit: contain;
    }
    .status-badge {
      font-size: 0.8em;
    }
    .card-footer {
      background-color: #f8f9fa;
    }
    .uploaded-marker {
        font-size: 0.75em;
        padding: 0.25em 0.5em;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>Batch Image Background Removal</h1>
      <button id="attachImagesButton" class="btn btn-info btn-lg" disabled>
        Attach Selected to Item
      </button>
    </div>

    <form id="uploadForm" class="mb-4">
      <div class="mb-3">
        <label for="imageFiles" class="form-label"
          >Select Images (PNG, JPG, WebP):</label
        >
        <input
          type="file"
          class="form-control"
          id="imageFiles"
          multiple
          accept="image/png, image/jpeg, image/webp"
        />
      </div>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="modelSelect" class="form-label">Model:</label>
          <select id="modelSelect" class="form-select">
            <option value="u2net" selected>U2Net (General Purpose)</option>
            <option value="u2netp">U2Netp (Lightweight)</option>
            <option value="u2net_human_seg">U2Net Human Segmentation</option>
            <option value="u2net_cloth_seg">U2Net Cloth Segmentation</option>
            <option value="silueta">Silueta (Alternative to U2Net)</option>
            <option value="isnet-general-use">IS-Net General Use</option>
            <option value="isnet-anime">IS-Net Anime</option>
          </select>
        </div>
        <div class="col-md-4 mb-3 d-flex align-items-end">
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              id="postProcessCheck"
            />
            <label class="form-check-label" for="postProcessCheck">
              Enable Post-Processing (Alpha Matting)
            </label>
          </div>
        </div>
        <div class="col-md-4 mb-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">
            Process Selected Images
          </button>
        </div>
      </div>
    </form>

    <hr />
    <div id="results" class="row mt-4">
      <!-- Image cards will be appended here -->
    </div>
  </div>

  <!-- Item Attachment Modal -->
  <div class="modal fade" id="itemAttachmentModal" tabindex="-1" aria-labelledby="itemAttachmentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="itemAttachmentModalLabel">Attach Images to Item</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <h6>Selected Images for Attachment:</h6>
          <ul id="selectedImagesListModal" class="list-group mb-3">
            <!-- Image URLs will be listed here -->
          </ul>
          <form id="itemAttachmentForm">
            <div class="mb-3">
              <label for="itemNumberInput" class="form-label">Item Number:</label>
              <input type="text" class="form-control" id="itemNumberInput" required>
            </div>
            <div id="modalAlertPlaceholder"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" form="itemAttachmentForm">Submit to Item</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/beerslider/dist/BeerSlider.min.js"></script>

  <script>
    const submitApiUrl = "/submit"; // Your backend endpoint for image processing
    const statusApiUrl = "/status/";   // Your backend endpoint for checking job status
    const associateApiUrl = "/api/v1/item/associate_images"; // NEW: Your backend endpoint for associating images with an item
    const apiKey = "secretApiKey"; // Replace with secure handling

    const UPLOADED_ITEMS_STORAGE_KEY = 'batchUploader_associatedJobIds';

    let jobFileMap = {};
    let sliderInstances = {};
    let itemAttachmentModalInstance; // For Bootstrap modal

    // --- LocalStorage Helpers for Associated Items ---
    function getAssociatedJobIds() {
        const stored = localStorage.getItem(UPLOADED_ITEMS_STORAGE_KEY);
        return stored ? JSON.parse(stored) : [];
    }

    function addAssociatedJobIds(jobIdsToAdd) {
        let currentJobIds = getAssociatedJobIds();
        jobIdsToAdd.forEach(jobId => {
            if (!currentJobIds.includes(jobId)) {
                currentJobIds.push(jobId);
            }
        });
        localStorage.setItem(UPLOADED_ITEMS_STORAGE_KEY, JSON.stringify(currentJobIds));
    }

    // --- UI Update Functions ---
    function updateAttachButtonStatus() {
      const anySelectedForAttachment = $('#results .select-for-attachment:checked').length > 0;
      $("#attachImagesButton").prop("disabled", !anySelectedForAttachment);
    }

    function applyAssociatedMarker(jobId) {
        const $card = $(`#card-${jobId}`);
        if ($card.length) {
            const associatedJobIds = getAssociatedJobIds();
            if (associatedJobIds.includes(jobId)) {
                $card.find('.uploaded-marker').show();
                // $card.find('.select-for-attachment').prop('checked', false).prop('disabled', true); // Optional: disable re-selection
            } else {
                $card.find('.uploaded-marker').hide();
                // $card.find('.select-for-attachment').prop('disabled', false);
            }
        }
    }
    function applyAllAssociatedMarkers() {
        const associatedJobIds = getAssociatedJobIds();
        associatedJobIds.forEach(jobId => {
            applyAssociatedMarker(jobId);
        });
         // Ensure un-associated ones are also correctly set (marker hidden)
        $('#results .image-card').each(function() {
            const cardJobId = $(this).data('job-id');
            if (cardJobId && !associatedJobIds.includes(cardJobId)) {
                $(this).find('.uploaded-marker').hide();
            }
        });
    }


    function initializeOrUpdateBeerSlider($card, originalImageUrl, processedImageUrl) {
      const $sliderWrapper = $card.find('.beerslider-wrapper-container');
      const originalFileName = $card.data('original-filename');
      const sliderContainerId = 'beer-slider-' + $card.data('job-id').replace(/-/g, '');

      if (sliderInstances[sliderContainerId]) {
          // Consider a more robust destroy/re-init if BeerSlider supports it
      }
      $sliderWrapper.removeClass('img-placeholder').empty();

      const $beerSliderDiv = $('<div>').attr('id', sliderContainerId).addClass('beer-slider');
      const $beforeImgTag = $('<img>').attr('src', originalImageUrl).attr('alt', 'Original: ' + originalFileName);
      const $beerRevealDiv = $('<div>').addClass('beer-reveal');
      const $afterImgTag = $('<img>').attr('src', processedImageUrl + `?t=${new Date().getTime()}`).attr('alt', 'Processed: ' + originalFileName);

      $beerRevealDiv.append($afterImgTag);
      $beerSliderDiv.append($beforeImgTag).append($beerRevealDiv);
      $sliderWrapper.append($beerSliderDiv);

      let imagesLoaded = 0;
      const totalImages = 2;

      function onImageLoad() {
          imagesLoaded++;
          if (imagesLoaded === totalImages) {
              try {
                  if (window.BeerSlider) {
                      const sliderElement = document.getElementById(sliderContainerId);
                      const instance = new BeerSlider(sliderElement, { start: 50 });
                      sliderInstances[sliderContainerId] = instance;
                  } else {
                       $sliderWrapper.addClass('img-placeholder').text('Slider library error.');
                  }
              } catch (e) {
                  console.error("Error initializing BeerSlider for #" + sliderContainerId + ":", e);
                  $sliderWrapper.addClass('img-placeholder').text('Error initializing slider.');
              }
          }
      }
      $beforeImgTag.on('load', onImageLoad).on('error', () => $sliderWrapper.addClass('img-placeholder').text('Error loading original image.'));
      $afterImgTag.on('load', onImageLoad).on('error', () => $sliderWrapper.addClass('img-placeholder').text('Error loading processed image.'));
      
      setTimeout(() => {
          if (imagesLoaded < totalImages && !$sliderWrapper.hasClass('img-placeholder')) {
               if ($beforeImgTag[0].complete && $afterImgTag[0].complete && $beforeImgTag[0].naturalWidth > 0 && $afterImgTag[0].naturalWidth > 0) {
                  if (imagesLoaded === 0) { onImageLoad(); onImageLoad(); }
                  else if (imagesLoaded === 1) { onImageLoad(); }
               }
          }
      }, 700);
    }

    function pollStatus(jobId, cardElement) {
      const $card = $(cardElement);
      const $statusText = $card.find(".status-text");
      const $progressBar = $card.find(".progress-bar");
      const $sliderWrapper = $card.find(".beerslider-wrapper-container");
      const $refreshButton = $card.find(".refresh-btn");
      const originalImageUrl = $card.data("original-url");

      $.getJSON(statusApiUrl + jobId, function (data) {
        $statusText.text(data.status.charAt(0).toUpperCase() + data.status.slice(1) + (data.eta > 0 ? ` (ETA: ${data.eta}s)` : ""));
        $refreshButton.prop("disabled", data.status === "processing" || data.status === "queued");

        if (data.status === "done") {
          $statusText.html('<span class="badge bg-success status-badge">‚úÖ Done</span>');
          $progressBar.removeClass("progress-bar-striped progress-bar-animated").addClass("bg-success").css("width", "100%");
          if (data.processed_image_url && originalImageUrl) {
            initializeOrUpdateBeerSlider($card, originalImageUrl, data.processed_image_url);
          } else {
            $sliderWrapper.addClass("img-placeholder").text("Image URLs missing for slider.");
          }
          $card.data("processed-url", data.processed_image_url);
          $card.find('input[name^="image_choice_"][value="processed"]').data("url", data.processed_image_url);
          applyAssociatedMarker(jobId); // Check if this processed item was previously associated
        } else if (data.status === "error") {
          $statusText.html(`<span class="badge bg-danger status-badge">‚ùå Error</span>: ${data.error_message || "Unknown error"}`);
          $progressBar.removeClass("progress-bar-striped progress-bar-animated").addClass("bg-danger").css("width", "100%");
          $sliderWrapper.addClass("img-placeholder").text("Processing Error: " + (data.error_message || "Unknown issue"));
        } else if (data.status === "processing" || data.status === "queued") {
          $statusText.html(`<span class="badge bg-info text-dark status-badge">${data.status === "processing" ? "‚öôÔ∏è Processing..." : "‚è≥ Queued..."}</span> (ETA: ${data.eta}s)`);
          $progressBar.addClass("progress-bar-striped progress-bar-animated").removeClass("bg-success bg-danger").css("width", "50%");
          setTimeout(() => pollStatus(jobId, cardElement), 2000);
        }
        // updateAttachButtonStatus(); // Radio buttons don't control this directly anymore
      }).fail(function () {
        $statusText.html('<span class="badge bg-danger status-badge">‚ùå Error</span>: Failed to get status');
        $progressBar.removeClass("progress-bar-striped progress-bar-animated").addClass("bg-danger").css("width", "100%");
        $sliderWrapper.addClass("img-placeholder").text("Status Check Failed.");
        $refreshButton.prop("disabled", false);
        // updateAttachButtonStatus();
      });
    }

    $(document).ready(function () {
      itemAttachmentModalInstance = new bootstrap.Modal(document.getElementById('itemAttachmentModal'));
      applyAllAssociatedMarkers(); // Mark already associated items on page load
      updateAttachButtonStatus();  // Initial state of the button

      $("#uploadForm").on("submit", function (e) {
        e.preventDefault();
        const files = $("#imageFiles")[0].files;
        const model = $("#modelSelect").val();
        const postProcess = $("#postProcessCheck").is(":checked");

        if (files.length === 0) { alert("Please select one or more image files."); return; }

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const formData = new FormData();
          formData.append("image_file", file);
          formData.append("api_key", apiKey);
          formData.append("model", model);
          formData.append("post_process", postProcess);

          const originalFileName = file.name;
          const tempJobId = `temp-${Date.now()}-${i}`;
          const selectAttachId = `select-attach-${tempJobId}`;

          const cardHtml = `
          <div class="col-md-4 image-card" id="card-${tempJobId}" data-original-filename="${originalFileName}">
            <div class="card">
              <div class="beerslider-wrapper-container img-placeholder">
                Original: Awaiting submission<br>Processed: Queued
              </div>
              <div class="card-body">
                <h5 class="card-title small">${originalFileName}</h5>
                <div class="progress mb-2" style="height: 10px;">
                  <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 10%"></div>
                </div>
                <p class="card-text status-text"><span class="badge bg-secondary status-badge">‚è≥ Submitting...</span></p>
                <p class="small text-muted job-id-text">Job ID: Pending...</p>
                <div class="form-check">
                  <input class="form-check-input image-select-radio" type="radio" name="image_choice_${tempJobId}" value="original" data-url="">
                  <label class="form-check-label small">Use Original</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input image-select-radio" type="radio" name="image_choice_${tempJobId}" value="processed" data-url="" checked>
                  <label class="form-check-label small">Use Processed</label>
                </div>
                <div class="form-check mt-2">
                    <input class="form-check-input select-for-attachment" type="checkbox" value="" id="${selectAttachId}">
                    <label class="form-check-label small" for="${selectAttachId}">Select for Item Attachment</label>
                </div>
                <span class="badge bg-info mt-1 uploaded-marker" style="display: none;">Associated with Item</span>
              </div>
              <div class="card-footer text-end">
                <button class="btn btn-sm btn-outline-primary refresh-btn" data-jobid="${tempJobId}" disabled>Re-process</button>
              </div>
            </div>
          </div>`;
          const $card = $(cardHtml);
          $("#results").append($card);

          $.ajax({
            url: submitApiUrl, method: "POST", data: formData, processData: false, contentType: false,
            success: function (data) {
              if (data.job_id) {
                jobFileMap[data.job_id] = file;
                const newSelectAttachId = `select-attach-${data.job_id}`;
                $card.attr("id", `card-${data.job_id}`);
                $card.data("job-id", data.job_id);
                $card.data("original-url", data.original_image_url);
                $card.find(".job-id-text").text(`Job ID: ${data.job_id}`);
                $card.find(".refresh-btn").data("jobid", data.job_id).prop("disabled", true);
                $card.find('input[name^="image_choice_"]').attr("name", `image_choice_${data.job_id}`);
                $card.find('input[id^="select-attach-"]').attr('id', newSelectAttachId).next('label').attr('for', newSelectAttachId);
                $card.find('input[value="original"]').data("url", data.original_image_url);
                $card.find(".beerslider-wrapper-container.img-placeholder")
                  .html(`Original: Waiting for server URL<br>Processed: ${data.status === "queued" ? "Queued" : "Processing..."}`);
                pollStatus(data.job_id, $card[0]);
                applyAssociatedMarker(data.job_id); // Check if this job was already associated
              } else {
                $card.find(".status-text").html('<span class="badge bg-danger status-badge">‚ùå Submission Error</span>');
                $card.find(".progress-bar").addClass("bg-danger").css("width", "100%");
                $card.find(".beerslider-wrapper-container.img-placeholder").text("Submission Error.");
              }
            },
            error: function (xhr) {
                let errorMsg = "Submission failed.";
                if (xhr.responseJSON && xhr.responseJSON.error) { errorMsg = xhr.responseJSON.error; }
                else if (xhr.responseJSON && xhr.responseJSON.detail) {
                  if (Array.isArray(xhr.responseJSON.detail)) { errorMsg = xhr.responseJSON.detail.map(d => `${d.loc.join(".")} - ${d.msg}`).join("; "); }
                  else { errorMsg = xhr.responseJSON.detail; }
                }
                $card.find(".status-text").html(`<span class="badge bg-danger status-badge">‚ùå Error</span>: ${errorMsg}`);
                $card.find(".progress-bar").addClass("bg-danger").css("width", "100%");
                $card.find(".beerslider-wrapper-container.img-placeholder").text("AJAX Submission Error.");
            },
          });
        }
        $("#imageFiles").val("");
        updateAttachButtonStatus(); // Update after adding cards
      });

      $("#results").on("click", ".refresh-btn", function () {
          const jobIdToRefresh = $(this).data("jobid");
          const originalFile = jobFileMap[jobIdToRefresh];
          const $card = $(`#card-${jobIdToRefresh}`);
          if (!originalFile) { alert("Original file not found for re-processing."); return; }
          const model = $("#modelSelect").val();
          const postProcess = $("#postProcessCheck").is(":checked");
          const formData = new FormData();
          formData.append("image_file", originalFile);
          formData.append("api_key", apiKey);
          formData.append("model", model);
          formData.append("post_process", postProcess);
          
          $card.find(".status-text").html('<span class="badge bg-secondary status-badge">üîÑ Re-submitting...</span>');
          $card.find(".progress-bar").removeClass("bg-success bg-danger").addClass("progress-bar-striped progress-bar-animated").css("width", "10%");
          $card.find(".beerslider-wrapper-container").addClass("img-placeholder").empty().text("Re-processing... (Slider will refresh)");
          $card.find(".refresh-btn").prop("disabled", true);
          $card.data("processed-url", null);
          $card.find('input[value="processed"]').data("url", null);
          // Note: The 'select-for-attachment' and 'uploaded-marker' for the OLD job ID remain.
          // A new card effectively replaces this one in terms of job_id, so the new one will get its own markers.

          $.ajax({
              url: submitApiUrl, method: "POST", data: formData, processData: false, contentType: false,
              success: function (newData) {
                  if (newData.job_id) {
                      // Update card with new job_id and reset relevant parts
                      const oldJobId = $card.data('job-id');
                      const oldSelectAttachId = `select-attach-${oldJobId}`;
                      const newSelectAttachId = `select-attach-${newData.job_id}`;

                      jobFileMap[newData.job_id] = originalFile; // Add new, old one will be orphaned if job id changes
                      if (oldJobId !== newData.job_id) delete jobFileMap[oldJobId];


                      $card.attr("id", `card-${newData.job_id}`);
                      $card.data("job-id", newData.job_id);
                      $card.data("original-url", newData.original_image_url);
                      $card.find(".job-id-text").text(`Job ID: ${newData.job_id}`);
                      $card.find(".refresh-btn").data("jobid", newData.job_id);
                      $card.find('input[name^="image_choice_"]').attr("name", `image_choice_${newData.job_id}`);
                      $card.find(`#${oldSelectAttachId}`).attr('id', newSelectAttachId).next('label').attr('for', newSelectAttachId);

                      $card.find('input[value="original"]').data("url", newData.original_image_url);
                      $card.find(".beerslider-wrapper-container.img-placeholder").html(`Original: Waiting for server URL<br>Processed: ${newData.status === "queued" ? "Queued" : "Processing..."}`);
                      $card.find('.select-for-attachment').prop('checked', false); // Uncheck on reprocess
                      pollStatus(newData.job_id, $card[0]);
                      applyAssociatedMarker(newData.job_id); // Apply marker for the new job ID
                  } else {
                      $card.find(".status-text").html('<span class="badge bg-danger status-badge">‚ùå Re-submission Error</span>');
                      $card.find(".refresh-btn").prop("disabled", false);
                  }
              },
              error: function () {
                  $card.find(".status-text").html('<span class="badge bg-danger status-badge">‚ùå Re-submission Failed</span>');
                  $card.find(".refresh-btn").prop("disabled", false);
              }
          });
      });

      // When "Select for Item Attachment" checkbox changes
      $("#results").on("change", ".select-for-attachment", function () {
        updateAttachButtonStatus();
      });

      // When "Attach Selected to Item" button is clicked
      $("#attachImagesButton").on("click", function () {
        const $selectedCheckboxes = $('#results .select-for-attachment:checked');
        if ($selectedCheckboxes.length === 0) {
          alert("Please select at least one image to attach.");
          return;
        }

        const $listElement = $("#selectedImagesListModal").empty();
        $("#modalAlertPlaceholder").empty();
        $("#itemNumberInput").val('');

        let imagesForModal = [];

        $selectedCheckboxes.each(function () {
          const $card = $(this).closest(".image-card");
          const jobId = $card.data("job-id");
          const originalFileName = $card.data("original-filename");
          const selectedVersion = $card.find(`input[name="image_choice_${jobId}"]:checked`).val();
          let imageUrl = $card.find(`input[name="image_choice_${jobId}"][value="${selectedVersion}"]`).data("url");
          
          if (jobId && !jobId.startsWith("temp-") && imageUrl) {
            imagesForModal.push({
                jobId: jobId,
                url: imageUrl,
                fileName: originalFileName,
                version: selectedVersion
            });
            $listElement.append(
              `<li class="list-group-item" data-job-id="${jobId}">
                 ${originalFileName} (${selectedVersion}) - <a href="${imageUrl}" target="_blank" class="small">View</a>
               </li>`
            );
          }
        });
        
        if (imagesForModal.length > 0) {
            itemAttachmentModalInstance.show();
        } else {
            alert("Selected images are not ready or have no URL. Please wait for processing to complete.");
        }
      });

      // When modal form is submitted
      $("#itemAttachmentForm").on("submit", function(e) {
        e.preventDefault();
        const itemNumber = $("#itemNumberInput").val().trim();
        if (!itemNumber) {
          $("#modalAlertPlaceholder").html('<div class="alert alert-danger" role="alert">Item Number is required.</div>');
          return;
        }
        $("#modalAlertPlaceholder").empty();

        const imagesToAssociate = [];
        const jobIdsToMark = [];

        $("#selectedImagesListModal .list-group-item").each(function() {
            const jobId = $(this).data("job-id");
            const $card = $(`#card-${jobId}`);
            const originalFileName = $card.data("original-filename");
            const selectedVersion = $card.find(`input[name="image_choice_${jobId}"]:checked`).val();
            const url = $card.find(`input[name="image_choice_${jobId}"][value="${selectedVersion}"]`).data("url");

            if (jobId && url) {
                imagesToAssociate.push({
                    job_id: jobId, // Good to send to backend for its own tracking if needed
                    image_url: url,
                    original_filename: originalFileName,
                    selected_version: selectedVersion
                });
                jobIdsToMark.push(jobId);
            }
        });

        if (imagesToAssociate.length === 0) {
          $("#modalAlertPlaceholder").html('<div class="alert alert-warning" role="alert">No valid images to associate.</div>');
          return;
        }

        // Placeholder for AJAX call to your backend
        console.log("Submitting to backend:", { item_number: itemNumber, images: imagesToAssociate });

        // SIMULATE BACKEND CALL
        // Replace this with your actual $.ajax call to 'associateApiUrl'
        // For demonstration, we'll assume success immediately
        //----------------------------------------------------
        // $.ajax({
        //   url: associateApiUrl,
        //   method: "POST",
        //   contentType: "application/json",
        //   data: JSON.stringify({ item_number: itemNumber, images: imagesToAssociate }),
        //   success: function(response) {
        //     console.log("Association successful:", response);
            addAssociatedJobIds(jobIdsToMark);
            jobIdsToMark.forEach(jobId => {
              applyAssociatedMarker(jobId);
              $(`#card-${jobId} .select-for-attachment`).prop('checked', false);
            });
            itemAttachmentModalInstance.hide();
            updateAttachButtonStatus();
            // Optionally, show a global success message (e.g., a toast)
            alert(`Images successfully associated with item number: ${itemNumber}`);
        //   },
        //   error: function(xhr) {
        //     let errorMsg = "Failed to associate images with item.";
        //     if (xhr.responseJSON && xhr.responseJSON.error) { errorMsg = xhr.responseJSON.error; }
        //     $("#modalAlertPlaceholder").html(`<div class="alert alert-danger" role="alert">${errorMsg}</div>`);
        //     console.error("Association error:", xhr);
        //   }
        // });
        //----------------------------------------------------
        // END SIMULATION - Remove alert() and uncomment AJAX above

      });
    }); // End document.ready
  </script>
</body>
</html>
